# 本日のサマリー
- 先週にAnsible環境構築とWebappへのCICDが出来たので、今週計測方法を試すまでを目標にします。
- [pprotein でボトルネックを探して ISUCON で優勝する](https://zenn.dev/team_soda/articles/20231206000000)を参考にする。
- Driverがゆんたんさん、オペレータがおのさん。
- 本日もZoomに集まって作業しました。（作業内容を録画しました。）
  - [Zoomレコーディング](https://us06web.zoom.us/rec/share/VzxbzVE6ls0mo-rG78MZcCCEaHQiidavp5cNt_ZWv-zVrQGKXyBaWLxKKRLODhBf.Td85YN57K7wH-Nww)

# 手順
- ゆんたんさん手元環境はMacなので堅めのgithubのcodespaces環境で作業する。
- アワノさんの[リポジトリ](https://github.com/Akijin007/isucon13)をフォーク。そのリポジトリでcodespacesを開く。
- codespace環境に[ここの手順](https://zenn.dev/team_soda/articles/20231206000000#%E5%91%A8%E8%BE%BA%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB)に従って周辺ツールのインストールを行う。
```bash
$ sudo apt install -y graphviz gv
$ sudo apt update
$ wget https://github.com/tkuchiki/slp/releases/download/v0.2.0/slp_linux_amd64.tar.gz
$ tar -xvf slp_linux_amd64.tar.gz
$ sudo mv slp /usr/local/bin/slp
$ wget https://github.com/tkuchiki/alp/releases/download/v1.0.21/alp_linux_amd64.tar.gz
$ tar -xvf alp_linux_amd64.tar.gz
$ sudo mv alp /usr/local/bin/alp
$ wget https://github.com/kaz/pprotein/releases/download/v1.2.3/pprotein_1.2.3_linux_amd64.tar.gz
$ tar -xvf pprotein_1.2.3_linux_amd64.tar.gz
$ rm *.gz  # pprotain以外は消す。今回不要。ここはお好みで。
$ ./pprotain
```
- ブラウザで(port 9000)を開くとpprotainの画面が出る。ここまででpprotainの動作確認まで完了。
- 次にデプロイ先のターゲットのAWS EC2インスタンスを用意して起動する。
- ssh接続の設定
  - codespaces環境でssh-keygenで鍵を生成してしまいましょう。公開鍵（~/.ssh/id_rsa.pubなど）を取っておく。
  - ローカルからubuntuでssh接続。`$ ssh -l ubuntu -i ~/.ssh/aws_secret_key.pem public_ip_address`
  - codespacesからの接続用の公開鍵を/home/isucon/.ssh/authorized_keysにペーストして保存。
  - codespacesから`$ ssh isucon@ip_address`で接続できればOK。
- codespacesからEC2にansibleが接続できるようにinvently.ymlを修正しipアドレスを書く。
- [Goアプリケーションのpprof](https://zenn.dev/team_soda/articles/20231206000000#go%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AEpprof)
に従って作業。codespacesのwebapp/go/main.goを編集する。
  - import文に必要なパッケージを追加。	"github.com/kaz/pprotein/integration/standalone/integrate"
  - 
  - codespacesのwebapp/go/main.goを編集する。echov4.EnableDebugHandler(e) を webmain 関数に置く。import文に...standalone/intagrateを追加。go standalone.Integrate(":19000")も追加。
- 改変したコードをansible-playbookでbuild_and_deployする。
- pprotainに起動したことを知らせるコードをinitializeHandelerに書く。
- banch実行。

QA
Q: alp/slpはどこにインストールしたか？
A: codespacesのpprotain環境に入れた。ベンチ対象の環境には不要。（後でMySQLとかにpprotain設定の追加も必要。）
