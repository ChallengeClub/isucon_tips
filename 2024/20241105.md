# 本日のサマリー
- 先週にAnsible環境構築とWebappへのCICDが出来たので、今週計測方法を試すまでを目標にします。
- [pprotein でボトルネックを探して ISUCON で優勝する](https://zenn.dev/team_soda/articles/20231206000000)を参考にする。
- Driverがゆんたんさん、オペレータがおのさん。
- 本日もZoomに集まって作業しました。（作業内容を録画しました。）
  - [Zoomレコーディング](https://us06web.zoom.us/rec/share/VzxbzVE6ls0mo-rG78MZcCCEaHQiidavp5cNt_ZWv-zVrQGKXyBaWLxKKRLODhBf.Td85YN57K7wH-Nww)

# 手順
- ゆんたんさん手元環境はMacなので堅めのgithubのcodespaces環境で作業する。
- アワノさんの[リポジトリ](https://github.com/Akijin007/isucon13)をフォーク。そのリポジトリでcodespacesを開く。
- codespace環境に[ここの手順](https://zenn.dev/team_soda/articles/20231206000000#%E5%91%A8%E8%BE%BA%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB)に従って周辺ツールのインストールを行う。
```bash
$ sudo apt install -y graphviz gv
$ sudo apt update
$ wget https://github.com/tkuchiki/slp/releases/download/v0.2.0/slp_linux_amd64.tar.gz
$ tar -xvf slp_linux_amd64.tar.gz
$ sudo mv slp /usr/local/bin/slp
$ wget https://github.com/tkuchiki/alp/releases/download/v1.0.21/alp_linux_amd64.tar.gz
$ tar -xvf alp_linux_amd64.tar.gz
$ sudo mv alp /usr/local/bin/alp
$ wget https://github.com/kaz/pprotein/releases/download/v1.2.3/pprotein_1.2.3_linux_amd64.tar.gz
$ tar -xvf pprotein_1.2.3_linux_amd64.tar.gz
$ rm *.gz  # pprotein以外は消す。今回不要なので。ここはお好みで。
$ ./pprotein
```
- ブラウザで(port 9000)を開くとpproteinの画面が出る。ここまででpproteinの動作確認まで完了。
- 次にデプロイ先のターゲットのAWS EC2インスタンスを用意して起動する。
- ssh接続の設定
  - codespaces環境でssh-keygenで鍵を生成してしまいましょう。公開鍵（~/.ssh/id_rsa.pubなど）を取っておく。
  - ローカルからubuntuでssh接続。`$ ssh -l ubuntu -i ~/.ssh/aws_secret_key.pem public_ip_address`
  - codespacesからの接続用の公開鍵を/home/isucon/.ssh/authorized_keysにペーストして保存。
  - codespacesから`$ ssh isucon@ip_address`で接続できればOK。
- [Goアプリケーションのpprof](https://zenn.dev/team_soda/articles/20231206000000#go%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AEpprof)
に従って作業。codespacesのwebapp/go/main.goを編集する。
  - import文に必要なパッケージを追加。	"github.com/kaz/pprotein/integration/standalone"
  - `$ go mod tidy`とかで適切に取得してくれる、筈。
  - codespacesのwebapp/go/main.goを編集する。go standalone.Integrate(":19000")をmain()関数に置く。（非同期でポート19000で待ち受け。）
  - main.goのinitializeHandlerでinitが呼ばれた直後に下記のコードを追加。これでcodespacesのpprotainに起動したことを知らせる。(codespaces-forwarded-port)はcodespaces環境のportタブでpublic公開して取得する。
```go
	go func() {
		if _, err := http.Get("(codespaces-forwarded-port)/api/group/collect"); err != nil {
			log.Printf("failed to communicate with pprotein: %v", err)
		}
	}()
```
- 改変したコードをansible-playbookでbuild_and_deployする。
  - codespacesからEC2にansibleが接続できるようにinvently.ymlを修正しipアドレスを書く。書き方は[ここ](https://github.com/mo124121/isucon13-try/blob/main/ansible/inventory.yaml)など参照。
  - EC2側のセキュリティ・グループのインバウンドのport:19000を開けておく。
  - `$ ansible-playbook -i inventory.yml -u isucon build_and_deploy.yml`
- pprotainの設定を変更。codespacesのportからlocalhostをブラウザで開いて、settingsタブのgroup/targetをlocalhostでなくEC2のIPアドレス:19000にする。
- EC2内でbanch実行。`$ ./bench run --enable-ssl`
- これでpprotainに分析されるログが取れているはず。codespacesのportからlocalhostをブラウザで開いてopenからpprotainのチャート(flamegraph)を視る。

QA
Q: alp/slpはどこにインストールしたか？  
A: codespacesのpprotain環境に入れた。ベンチ対象の環境には不要。（後でnginxやMySQLとかにログ出力設定の追加も必要です。）  
C: Dockerでprometheusやpprotainなど、profiler以外のものは一式入れたものを作る予定。(おの)  

# 後日
おのさんが一式更新された[可視化詰め合わせ環境](https://github.com/mo124121/isucon-o11y)  
とりあえず可能な限り可視化で楽ができるようなものを詰め合わせておきました。  
監視対象へのエージェント導入・データ閲覧用のウェブアプリ起動を一式実施可能です。  

アプリへの修正は行わないので、本番でも基本的にそのまま使えるはずな一方、  
アプリへの修正を行わないと、測定の開始自動化やgo言語のプロファイリングは行われません。  
